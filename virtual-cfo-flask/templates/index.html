<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RelentlessAi | CFO</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <!-- Animated Background -->
    <div class="background-container">
        <div class="stars"></div>
        <div class="grid-overlay"></div>
        <div class="particles"></div>
    </div>

    <!-- Main Dashboard -->
    <div class="dashboard-container">
        <!-- Fixed Sidebar -->
        <aside class="sidebar" id="sidebar">
            <!-- Brand Section -->
            <div class="sidebar-brand">
                <div class="logo">
                    <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                        <circle cx="16" cy="16" r="12" fill="url(#gradient)" stroke="url(#accent)" stroke-width="2"/>
                        <path d="M12 16L16 12L20 16L16 20L12 16Z" fill="white" opacity="0.9"/>
                        <defs>
                            <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#00D4FF"/>
                                <stop offset="100%" style="stop-color:#8B5CF6"/>
                            </linearGradient>
                            <linearGradient id="accent" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#00F5FF"/>
                                <stop offset="100%" style="stop-color:#FF00F5"/>
                            </linearGradient>
                        </defs>
                    </svg>
                </div>
                <div class="brand-text">
                    <h1>RelentlessAi</h1>
                    <span class="subtitle">CFO</span>
                </div>
            </div>

            <!-- Theme Toggle -->
            <div class="sidebar-controls">
                <button class="sidebar-toggle" id="sidebarToggle" title="Collapse sidebar">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                        <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <button class="theme-toggle" id="themeToggle">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                        <circle cx="12" cy="12" r="5" stroke="currentColor" stroke-width="2"/>
                        <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2"/>
                    </svg>
                </button>
            </div>

            <!-- Sidebar Content -->
            {% if not file_uploaded %}
            <!-- Upload Section in Sidebar -->
            <div class="sidebar-section">
                <div class="glass-card upload-card">
                    <div class="card-header">
                        <div class="card-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6z" stroke="currentColor" stroke-width="2"/>
                                <polyline points="14,2 14,8 20,8" stroke="currentColor" stroke-width="2"/>
                                <line x1="16" y1="13" x2="8" y2="13" stroke="currentColor" stroke-width="2"/>
                                <line x1="16" y1="17" x2="8" y2="17" stroke="currentColor" stroke-width="2"/>
                                <polyline points="10,9 9,9 8,9" stroke="currentColor" stroke-width="2"/>
                            </svg>
                        </div>
                        <h2>Financial Data Upload</h2>
                        <p>Upload your financial data to unlock AI-powered insights</p>
                    </div>
                    
                    <form method="post" enctype="multipart/form-data" class="upload-form">
                        <div class="file-drop-zone" id="fileDropZone">
                            <div class="drop-content">
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" class="drop-icon">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6z" stroke="currentColor" stroke-width="2"/>
                                    <polyline points="14,2 14,8 20,8" stroke="currentColor" stroke-width="2"/>
                                    <line x1="16" y1="13" x2="8" y2="13" stroke="currentColor" stroke-width="2"/>
                                    <line x1="16" y1="17" x2="8" y2="17" stroke="currentColor" stroke-width="2"/>
                                    <polyline points="10,9 9,9 8,9" stroke="currentColor" stroke-width="2"/>
                                </svg>
                                <h3>Drop your CSV file here</h3>
                                <p>or click to browse</p>
                                <input type="file" name="file" accept=".csv" required id="fileInput" class="hidden-input">
                            </div>
                        </div>
                        <button type="submit" class="upload-btn">
                            <span>Upload & Analyze</span>
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                                <path d="M12 5v14M5 12l7-7 7 7" stroke="currentColor" stroke-width="2"/>
                            </svg>
                        </button>
        </form>
                </div>
            </div>
            {% else %}
            
            <!-- Data Loaded Section -->
            <div class="sidebar-section">
                <div class="glass-card status-card">
                    <div class="card-header">
                        <div class="card-icon success">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                                <path d="M9 12l2 2 4-4" stroke="currentColor" stroke-width="2"/>
                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                            </svg>
                        </div>
                        <h3>Data Loaded</h3>
                    </div>
                    <div class="status-content">
                        <p class="filename">{{ filename }}</p>
                        <div class="status-indicator">
                            <div class="indicator-dot"></div>
                            <span>Ready for Analysis</span>
                        </div>
                        <!-- Persistent CSV Files List -->
                        <div class="csv-files-list" id="csvFilesList">
                            <h4>Uploaded Files:</h4>
                            <ul id="uploadedFilesList">
                                <!-- Files will be populated here -->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions Section -->
            <div class="sidebar-section">
                <div class="glass-card actions-card">
                    <div class="card-header">
                        <div class="card-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                                <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"/>
                                <path d="M12 1v6M12 17v6M4.22 4.22l4.24 4.24M15.54 15.54l4.24 4.24M1 12h6M17 12h6M4.22 19.78l4.24-4.24M15.54 8.46l4.24-4.24" stroke="currentColor" stroke-width="2"/>
                            </svg>
                        </div>
                        <h3>Quick Actions</h3>
                    </div>
                    <div class="action-buttons">
                        <button class="action-btn" data-prompt="Forecast sales for the next 12 months">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                <polyline points="22,12 18,12 15,21 9,3 6,12 2,12" stroke="currentColor" stroke-width="2"/>
                            </svg>
                            <span>Forecast</span>
                        </button>
                        <button class="action-btn" data-prompt="Check for anomalies in the data">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                                <path d="M12 6v6l4 2" stroke="currentColor" stroke-width="2"/>
                            </svg>
                            <span>Anomalies</span>
                        </button>
                        <button class="action-btn" data-prompt="Show me the profit margins">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="2"/>
                                <circle cx="8.5" cy="7" r="4" stroke="currentColor" stroke-width="2"/>
                                <line x1="20" y1="8" x2="20" y2="14" stroke="currentColor" stroke-width="2"/>
                                <line x1="23" y1="11" x2="17" y2="11" stroke="currentColor" stroke-width="2"/>
                            </svg>
                            <span>Margins</span>
                        </button>
                        <button class="action-btn" data-prompt="Give me strategic advice for growth">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" stroke="currentColor" stroke-width="2"/>
                            </svg>
                            <span>Strategy</span>
                        </button>
                    </div>
                </div>
            </div>
            {% endif %}
        </aside>

        <!-- Main Content Area -->
        <main class="main-content" id="mainContent">
        {% if file_uploaded %}
            <!-- Centered Chat Interface -->
            <div class="chat-center-container">
                <div class="glass-card chat-card">
                    <div class="card-header">
                        <div class="card-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" stroke="currentColor" stroke-width="2"/>
                            </svg>
                        </div>
                        <h3>Your Personal CFO</h3>
                        <div class="ai-status">
                            <div class="pulse-dot"></div>
                            <span>Online</span>
                        </div>
                    </div>
                    
                    <div class="chat-container">
                        <div id="chatbox" class="chat-messages"></div>
                        
                        <div class="chat-input-container">
                            <div class="input-wrapper">
                                <input type="text" id="userInput" placeholder="Ask your CFO anything..." class="chat-input">
                                <button id="sendButton" class="send-btn">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                                        <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" stroke="currentColor" stroke-width="2"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
        </main>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <p>&copy; All Rights Reserved to RelentlessAi</p>
    </footer>

<script>
    // Theme Toggle
    const themeToggle = document.getElementById('themeToggle');
    const sidebarToggle = document.getElementById('sidebarToggle');
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('mainContent');
    const body = document.body;
    
    // Check for saved theme preference or default to dark
    const savedTheme = localStorage.getItem('theme') || 'dark';
    body.classList.add(savedTheme);
    
    themeToggle.addEventListener('click', () => {
        body.classList.toggle('light');
        body.classList.toggle('dark');
        localStorage.setItem('theme', body.classList.contains('light') ? 'light' : 'dark');
    });

    // Sidebar collapse/expand with persistence
    const savedSidebar = localStorage.getItem('sidebar-collapsed') === 'true';
    if (savedSidebar) {
        sidebar.classList.add('collapsed');
    }
    if (sidebarToggle) {
        sidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('collapsed');
            const isCollapsed = sidebar.classList.contains('collapsed');
            localStorage.setItem('sidebar-collapsed', String(isCollapsed));
        });
    }

    // File Drop Zone
    const fileDropZone = document.getElementById('fileDropZone');
    const fileInput = document.getElementById('fileInput');
    
    if (fileDropZone) {
        fileDropZone.addEventListener('click', () => fileInput.click());
        
        fileDropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileDropZone.classList.add('drag-over');
        });
        
        fileDropZone.addEventListener('dragleave', () => {
            fileDropZone.classList.remove('drag-over');
        });
        
        fileDropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            fileDropZone.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type === 'text/csv') {
                fileInput.files = files;
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                fileDropZone.classList.add('file-selected');
            }
        });
    }

    // Quick Action Buttons
    document.querySelectorAll('.action-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const prompt = btn.getAttribute('data-prompt');
            const userInput = document.getElementById('userInput');
            if (userInput) {
                userInput.value = prompt;
                sendMessage();
            }
        });
    });

    // Chat Interface
        const userInput = document.getElementById('userInput');
        const chatbox = document.getElementById('chatbox');
        const sendButton = document.getElementById('sendButton');

    if (userInput && chatbox && sendButton) {
        async function sendMessage() {
            const userText = userInput.value;
            if (userText.trim() === "") return;

            appendMessage(userText, 'user-message');
            userInput.value = '';
            
            const loadingDivId = 'loading-' + Date.now();
            appendMessage('<div class="loading-dots"><span></span><span></span><span></span></div>', 'bot-message', loadingDivId);

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: userText })
                });

                const data = await response.json();
                const loadingDiv = document.getElementById(loadingDivId);
                
                if (data.error) {
                    loadingDiv.innerHTML = `<div class="error-message"><strong>Error:</strong> ${data.error}</div>`;
                } else {
                    let botResponseHTML = `<div class="response-content">${data.response.replace(/\n/g, '<br>')}</div>`;
                    // Prefer image_url; gracefully fallback to embedded base64 if the URL fails or is missing
                    if (data.image_url || data.image_data_url) {
                        const primarySrc = data.image_url ? `${data.image_url}?t=${Date.now()}` : (data.image_data_url || '');
                        const onErr = data.image_data_url ? `onerror="this.onerror=null; this.src='${data.image_data_url}'"` : '';
                        botResponseHTML += `<div class="plot-container"><img src="${primarySrc}" ${onErr} alt="Generated Analysis" class="plot-image"></div>`;
                        if (data.image_url) {
                            botResponseHTML += `<div style="margin-top:6px"><a href="${data.image_url}" target="_blank" rel="noopener" style="color:#38bdf8;text-decoration:underline">Open chart in new tab</a></div>`;
                        }
                    }
                    if (data.secondary_image_url) {
                        botResponseHTML += `<div class="plot-container"><img src="${data.secondary_image_url}?t=${Date.now()}" alt="Secondary Plot" class="plot-image"></div>`;
                    }
                    loadingDiv.innerHTML = botResponseHTML;
                }
            } catch (error) {
                console.error("Error:", error);
                const loadingDiv = document.getElementById(loadingDivId);
                loadingDiv.innerHTML = `<div class="error-message">Sorry, a connection error occurred.</div>`;
            }
        }

        function appendMessage(text, className, id = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${className}`;
            if (id) messageDiv.id = id;
            messageDiv.innerHTML = text;
            chatbox.appendChild(messageDiv);
            chatbox.scrollTop = chatbox.scrollHeight;
        }

        sendButton.addEventListener('click', sendMessage);
        userInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });
    }

    // Persistent CSV Files Storage
    function loadUploadedFiles() {
        const uploadedFiles = JSON.parse(localStorage.getItem('uploadedCSVFiles') || '[]');
        const filesList = document.getElementById('uploadedFilesList');
        
        if (filesList) {
            filesList.innerHTML = '';
            uploadedFiles.forEach(filename => {
                const li = document.createElement('li');
                li.textContent = filename;
                filesList.appendChild(li);
            });
        }
    }

    function addUploadedFile(filename) {
        const uploadedFiles = JSON.parse(localStorage.getItem('uploadedCSVFiles') || '[]');
        if (!uploadedFiles.includes(filename)) {
            uploadedFiles.push(filename);
            localStorage.setItem('uploadedCSVFiles', JSON.stringify(uploadedFiles));
            loadUploadedFiles();
        }
    }

    // Analytics Data Loading
    const dataPointsElement = document.getElementById('dataPoints');
    if (dataPointsElement) {
        // Simulate data loading
        setTimeout(() => {
            dataPointsElement.textContent = '627 rows';
        }, 1000);
    }

    // Add smooth animations
    document.addEventListener('DOMContentLoaded', () => {
        const cards = document.querySelectorAll('.glass-card');
        cards.forEach((card, index) => {
            card.style.animationDelay = `${index * 0.1}s`;
            card.classList.add('fade-in-up');
        });
        
        // Load uploaded files on page load
        loadUploadedFiles();
        
        // Check if there's a current file and add it to the list
        const currentFilename = '{{ filename }}';
        if (currentFilename && currentFilename !== 'None') {
            addUploadedFile(currentFilename);
        }
    });
</script>

</body>
</html>